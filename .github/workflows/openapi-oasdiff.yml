name: OpenAPI Backward Compatibility Check

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'openapi/**'

jobs:
  openapi-diff:
    runs-on: ubuntu-latest
    name: Check OpenAPI Backward Compatibility
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Install oasdiff
        run: |
          go install github.com/oasdiff/oasdiff@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
        env:
          GO111MODULE: on
      
      - name: Get base branch
        id: base-branch
        run: |
          echo "base_ref=${{ github.base_ref }}" >> $GITHUB_OUTPUT
      
      - name: Check API files
        id: check-api
        continue-on-error: true
        run: |
          echo "Checking OpenAPI API files for breaking changes..."
          git fetch origin ${{ steps.base-branch.outputs.base_ref }}
          
          # Track if any domain has breaking changes
          domains_have_breaking=false
          
          # Loop through each domain directory
          for domain_dir in openapi/*/; do
            domain=$(basename "$domain_dir")
            api_file="${domain_dir}${domain}-api.yaml"
            models_file="${domain_dir}${domain}-models.yaml"
            
            if [ ! -f "$api_file" ]; then
              echo "⏭️ Skipping $domain (no API file)"
              continue
            fi
            
            echo ""
            echo "========================================="
            echo "Checking domain: $domain"
            echo "========================================="
            
            # Create temp directory for this domain
            mkdir -p "/tmp/openapi-base/$domain"
            
            # Get the base version of the API file
            if ! git show origin/${{ steps.base-branch.outputs.base_ref }}:$api_file > "/tmp/openapi-base/$domain/${domain}-api.yaml" 2>/dev/null; then
              echo "⏭️ $api_file is new, skipping..."
              continue
            fi
            
            # Copy base schema files for this domain
            if [ -d "${domain_dir}schemas" ]; then
              mkdir -p "/tmp/openapi-base/$domain/schemas"
              for schema in ${domain_dir}schemas/*.{json,yaml}; do
                if [ -f "$schema" ]; then
                  filename=$(basename "$schema")
                  git show origin/${{ steps.base-branch.outputs.base_ref }}:$schema > "/tmp/openapi-base/$domain/schemas/$filename" 2>/dev/null || true
                fi
              done
            fi
            
            # Get base models file if it exists
            if [ -f "$models_file" ]; then
              git show origin/${{ steps.base-branch.outputs.base_ref }}:$models_file > "/tmp/openapi-base/$domain/${domain}-models.yaml" 2>/dev/null || true
            fi
            
            # Run oasdiff breaking check
            echo "Running oasdiff for $domain..."
            cd "/tmp/openapi-base/$domain"
            if oasdiff breaking "${domain}-api.yaml" "$GITHUB_WORKSPACE/$api_file" --composed --format text --fail-on WARN; then
              echo "✅ No breaking changes in $domain API"
            else
              echo "❌ Breaking changes detected in $domain API"
              domains_have_breaking=true
            fi
            cd "$GITHUB_WORKSPACE"
          done
          
          if [ "$domains_have_breaking" = true ]; then
            echo "api_breaking=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "api_breaking=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Check Models files
        id: check-models
        continue-on-error: true
        run: |
          echo "Checking OpenAPI Models files for breaking changes..."
          
          # Track if any domain has breaking changes
          domains_have_breaking=false
          
          # Loop through each domain directory
          for domain_dir in openapi/*/; do
            domain=$(basename "$domain_dir")
            models_file="${domain_dir}${domain}-models.yaml"
            
            if [ ! -f "$models_file" ]; then
              echo "⏭️ Skipping $domain (no models file)"
              continue
            fi
            
            echo ""
            echo "========================================="
            echo "Checking models for domain: $domain"
            echo "========================================="
            
            # Get the base version of the models file (should already exist from check-api step)
            if [ ! -f "/tmp/openapi-base/$domain/${domain}-models.yaml" ]; then
              if ! git show origin/${{ steps.base-branch.outputs.base_ref }}:$models_file > "/tmp/openapi-base/$domain/${domain}-models.yaml" 2>/dev/null; then
                echo "⏭️ $models_file is new, skipping..."
                continue
              fi
            fi
            
            # Run oasdiff - models file might not have paths, skip if invalid
            cd "/tmp/openapi-base/$domain"
            if oasdiff breaking "${domain}-models.yaml" "$GITHUB_WORKSPACE/$models_file" --composed --format text --fail-on WARN 2>/dev/null; then
              echo "✅ No breaking changes in $domain models"
            else
              exit_code=$?
              if [ $exit_code -eq 1 ]; then
                echo "❌ Breaking changes detected in $domain models"
                domains_have_breaking=true
              else
                echo "⏭️ Skipping $domain models (no paths defined)"
              fi
            fi
            cd "$GITHUB_WORKSPACE"
          done
          
          if [ "$domains_have_breaking" = true ]; then
            echo "models_breaking=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "models_breaking=false" >> $GITHUB_OUTPUT
          fi
           
      - name: Summary
        if: always()
        run: |
          echo "## OpenAPI Backward Compatibility Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          api_status="${{ steps.check-api.outcome }}"
          models_status="${{ steps.check-models.outcome }}"
          
          echo "| Domain | API Status | Models Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------------|---------------|" >> $GITHUB_STEP_SUMMARY
          
          # Show status for each domain
          for domain_dir in openapi/*/; do
            domain=$(basename "$domain_dir")
            api_file="${domain_dir}${domain}-api.yaml"
            models_file="${domain_dir}${domain}-models.yaml"
            
            api_cell="N/A"
            models_cell="N/A"
            
            if [ -f "$api_file" ]; then
              if [ "$api_status" = "success" ]; then
                api_cell="✅ No breaking changes"
              elif [ "$api_status" = "failure" ]; then
                api_cell="❌ Breaking changes"
              else
                api_cell="⏭️ Skipped"
              fi
            fi
            
            if [ -f "$models_file" ]; then
              if [ "$models_status" = "success" ]; then
                models_cell="✅ No breaking changes"
              elif [ "$models_status" = "failure" ]; then
                models_cell="❌ Breaking changes"
              else
                models_cell="⏭️ Skipped"
              fi
            fi
            
            echo "| $domain | $api_cell | $models_cell |" >> $GITHUB_STEP_SUMMARY
          done
      
      - name: Fail if breaking changes detected
        if: steps.check-api.outcome == 'failure' || steps.check-models.outcome == 'failure'
        run: |
          echo "❌ Breaking changes detected in OpenAPI specifications"
          echo "Please review the changes and ensure backward compatibility or update the version accordingly."
          exit 1
