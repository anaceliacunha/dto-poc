name: OpenAPI Backward Compatibility - Redocly

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'openapi/**'

jobs:
  redocly-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Redocly CLI
        run: npm install -g @redocly/cli
      
      - name: Get base branch files
        run: |
          git fetch origin ${{ github.base_ref }}
          mkdir -p /tmp/openapi-base/schemas
          
          # Copy base branch files to temp directory using git show
          git show origin/${{ github.base_ref }}:openapi/openapi-api.yaml > /tmp/openapi-base/openapi-api.yaml 2>/dev/null || echo "No openapi-api.yaml in base"
          git show origin/${{ github.base_ref }}:openapi/openapi-models.yaml > /tmp/openapi-base/openapi-models.yaml 2>/dev/null || echo "No openapi-models.yaml in base"
          
          # Copy schema files
          for schema in openapi/schemas/*.json openapi/schemas/*.yaml; do
            if [ -f "$schema" ]; then
              filename=$(basename "$schema")
              git show origin/${{ github.base_ref }}:openapi/schemas/$filename > /tmp/openapi-base/schemas/$filename 2>/dev/null || echo "No $filename in base"
            fi
          done
      
      - name: Compare with base - API
        continue-on-error: true
        run: |
          if [ -f /tmp/openapi-base/openapi-api.yaml ]; then
            echo "========================================="
            echo "Comparing openapi-api.yaml"
            echo "========================================="
            redocly diff /tmp/openapi-base/openapi-api.yaml openapi/openapi-api.yaml --format=stylish
          else
            echo "No base version of openapi-api.yaml found"
          fi
      
      - name: Compare with base - Models
        continue-on-error: true
        run: |
          if [ -f /tmp/openapi-base/openapi-models.yaml ]; then
            echo "========================================="
            echo "Comparing openapi-models.yaml"
            echo "========================================="
            redocly diff /tmp/openapi-base/openapi-models.yaml openapi/openapi-models.yaml --format=stylish
          else
            echo "No base version of openapi-models.yaml found"
          fi
      
      - name: Summary
        run: |
          echo "‚úÖ Redocly validation complete"
          echo ""
          echo "üìù Note: Redocly CLI provides linting and diff comparison."
          echo "For strict breaking change detection, use the oasdiff workflow."
