name: JSON Schema Compatibility Check

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'openapi/*/schemas/**'

jobs:
  json-schema-diff:
    runs-on: ubuntu-latest
    name: Check JSON Schema Backward Compatibility
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install json-schema-diff-validator
        run: npm install -g json-schema-diff-validator
      
      - name: Get base branch
        id: base-branch
        run: |
          echo "base_ref=${{ github.base_ref }}" >> $GITHUB_OUTPUT
      
      - name: Check JSON Schema files
        id: check-schemas
        continue-on-error: true
        run: |
          echo "Checking JSON Schema files for breaking changes..."
          git fetch origin ${{ steps.base-branch.outputs.base_ref }}
          
          # Track if any schema has breaking changes
          schemas_have_breaking=false
          
          # Create temp directory for base schemas
          mkdir -p /tmp/base-schemas
          
          # Loop through each domain directory
          for domain_dir in openapi/*/; do
            domain=$(basename "$domain_dir")
            schemas_dir="${domain_dir}schemas"
            
            if [ ! -d "$schemas_dir" ]; then
              echo "‚è≠Ô∏è Skipping $domain (no schemas directory)"
              continue
            fi
            
            echo ""
            echo "========================================="
            echo "Checking schemas for domain: $domain"
            echo "========================================="
            
            # Create domain-specific temp directory
            mkdir -p "/tmp/base-schemas/$domain"
            
            # Check each JSON schema file in this domain
            for schema in ${schemas_dir}/*.json; do
              if [ -f "$schema" ]; then
                filename=$(basename "$schema")
                echo ""
                echo "-----------------------------------------"
                echo "Checking $domain/$filename..."
                echo "-----------------------------------------"
                
                # Get base version
                if ! git show origin/${{ steps.base-branch.outputs.base_ref }}:$schema > "/tmp/base-schemas/$domain/$filename" 2>/dev/null; then
                  echo "‚è≠Ô∏è $filename is new in $domain, skipping..."
                  continue
                fi
                
                # Check if files are different
                if diff -q "/tmp/base-schemas/$domain/$filename" "$schema" > /dev/null 2>&1; then
                  echo "‚úÖ No changes in $domain/$filename"
                  continue
                fi
                
                echo "üìù File has changed, checking for breaking changes..."
                
                # Run json-schema-diff-validator
                if json-schema-diff-validator "/tmp/base-schemas/$domain/$filename" "$schema"; then
                  echo "‚úÖ No breaking changes in $domain/$filename"
                else
                  exit_code=$?
                  if [ $exit_code -ne 0 ]; then
                    echo "‚ùå Breaking changes detected in $domain/$filename"
                    schemas_have_breaking=true
                  fi
                fi
              fi
            done
          done
          
          if [ "$schemas_have_breaking" = true ]; then
            echo "schemas_breaking=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "schemas_breaking=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "## JSON Schema Compatibility Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          schemas_status="${{ steps.check-schemas.outcome }}"
          
          echo "| Domain | Schemas Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------------|" >> $GITHUB_STEP_SUMMARY
          
          # Show status for each domain
          for domain_dir in openapi/*/; do
            domain=$(basename "$domain_dir")
            schemas_dir="${domain_dir}schemas"
            
            if [ -d "$schemas_dir" ] && compgen -G "${schemas_dir}/*.json" > /dev/null; then
              if [ "$schemas_status" = "success" ]; then
                echo "| $domain | ‚úÖ No breaking changes |" >> $GITHUB_STEP_SUMMARY
              elif [ "$schemas_status" = "failure" ]; then
                echo "| $domain | ‚ùå Breaking changes detected |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $domain | ‚è≠Ô∏è Skipped or not found |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
      
      - name: Fail if breaking changes detected
        if: steps.check-schemas.outcome == 'failure'
        run: |
          echo "‚ùå Breaking changes detected in JSON Schema files"
          echo "Please review the changes and ensure backward compatibility."
          exit 1
