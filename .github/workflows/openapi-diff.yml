name: OpenAPI Backward Compatibility

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  bc-check:
    runs-on: ubuntu-latest
    env:
      SPEC_DIR: openapi
      SPEC_EXTS: 'ya?ml|json'
    steps:
      - name: Checkout PR branch (with full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          git fetch origin "${{ github.base_ref }}"

      - name: List changed OpenAPI specs
        id: changed
        shell: bash
        run: |
          set -euo pipefail
          { git diff --name-only "origin/${{ github.base_ref }}...HEAD" \
              | grep -E "^(${SPEC_DIR})/.*\.(${SPEC_EXTS})$" \
              || true; } > changed_specs.txt

          # Ensure file exists even if empty
          touch changed_specs.txt

          echo "Changed specs:"
          cat changed_specs.txt || true

          COUNT=$(wc -l < changed_specs.txt | tr -d ' ')
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

      - name: Skip if no specs changed
        if: steps.changed.outputs.count == '0'
        run: echo "No OpenAPI files changed. Skipping."

      - name: Prepare base versions of changed specs
        if: steps.changed.outputs.count != '0'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .openapi-old .openapi-old-bundled .openapi-new-bundled

          # Mirror the entire base openapi/ tree so $ref resolution works during bundling
          git ls-tree -r --name-only "origin/${{ github.base_ref }}" openapi | while read -r FILE; do
            mkdir -p ".openapi-old/$(dirname "$FILE")"
            git show "origin/${{ github.base_ref }}:$FILE" > ".openapi-old/$FILE"
          done

          # Record which changed specs are new (absent in base)
          while IFS= read -r f; do
            if ! [ -f ".openapi-old/$f" ]; then
              echo "NEW_SPEC $f" >> .openapi-old/new_files.txt
            fi
          done < changed_specs.txt

      - name: Run openapi-diff on changed specs (dereferenced)
        if: steps.changed.outputs.count != '0'
        shell: bash
        run: |
          set -euo pipefail
          FAILURES=0

          while IFS= read -r f; do
            echo "────────────────────────────────────────"
            echo "Comparing: origin/${{ github.base_ref }} ↔ HEAD"
            echo "$f"
            echo "────────────────────────────────────────"

            if [ -f ".openapi-old/$f" ]; then
              mkdir -p ".openapi-old-bundled/$(dirname "$f")" ".openapi-new-bundled/$(dirname "$f")"

              npx @redocly/cli@latest bundle ".openapi-old/$f" --dereferenced --output ".openapi-old-bundled/$f"
              npx @redocly/cli@latest bundle "$f" --dereferenced --output ".openapi-new-bundled/$f"

              docker run --rm -v "$PWD:/work" -w /work openapitools/openapi-diff:latest \
                "/work/.openapi-old-bundled/$f" "/work/.openapi-new-bundled/$f" \
                --fail-on-incompatible \
                --fail-on-changed || FAILURES=$((FAILURES+1))
            else
              echo "File is NEW in this PR (no base version): $f"
              echo "Skipping comparison (treat as non-breaking)."
            fi

            echo ""
          done < changed_specs.txt

          if [ "$FAILURES" -gt 0 ]; then
            echo "::error::Detected $FAILURES breaking or changed OpenAPI schema(s)."
            exit 2
          fi

      - name: Upload diff logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openapi-diff-logs
          path: |
            changed_specs.txt
            .openapi-old/new_files.txt
            .openapi-old-bundled
            .openapi-new-bundled
          if-no-files-found: ignore
