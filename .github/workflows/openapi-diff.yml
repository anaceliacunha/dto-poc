name: OpenAPI Backward Compatibility Check

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'openapi/**'
  push:
    branches:
      - 'dev/**'
    paths:
      - 'openapi/**'

jobs:
  openapi-diff:
    runs-on: ubuntu-latest
    name: Check OpenAPI Backward Compatibility
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install oasdiff
        run: |
          go install github.com/oasdiff/oasdiff@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
        env:
          GO111MODULE: on
      
      - name: Get base branch
        id: base-branch
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "base_ref=${{ github.base_ref }}" >> $GITHUB_OUTPUT
          else
            echo "base_ref=main" >> $GITHUB_OUTPUT
          fi
      
      - name: Check openapi-api.yaml
        id: check-api
        continue-on-error: true
        run: |
          echo "Checking openapi/openapi-api.yaml for breaking changes..."
          git fetch origin ${{ steps.base-branch.outputs.base_ref }}
          
          # Get the base version of the file and its referenced schemas
          git show origin/${{ steps.base-branch.outputs.base_ref }}:openapi/openapi-api.yaml > /tmp/base-openapi-api.yaml || {
            echo "File doesn't exist in base branch, skipping..."
            exit 0
          }
          
          # Copy base schema files to temp directory maintaining directory structure
          mkdir -p /tmp/openapi-base/schemas
          for schema in openapi/schemas/*.json openapi/schemas/*.yaml; do
            if [ -f "$schema" ]; then
              filename=$(basename "$schema")
              git show origin/${{ steps.base-branch.outputs.base_ref }}:$schema > /tmp/openapi-base/schemas/$filename 2>/dev/null || true
            fi
          done
          
          # Move the base API file to the same directory structure
          mv /tmp/base-openapi-api.yaml /tmp/openapi-base/openapi-api.yaml
          
          # Run oasdiff breaking check with detailed output
          # Change to /tmp/openapi-base so relative references resolve correctly for base file
          # Use absolute path for revision file
          echo "Running oasdiff breaking check..."
          echo "========================================="
          cd /tmp/openapi-base
          oasdiff breaking openapi-api.yaml "$GITHUB_WORKSPACE/openapi/openapi-api.yaml" --composed --format text --fail-on ERR && {
            echo "✅ No breaking changes in openapi-api.yaml"
            echo "api_breaking=false" >> $GITHUB_OUTPUT
          } || {
            echo "❌ Breaking changes detected in openapi-api.yaml"
            echo "api_breaking=true" >> $GITHUB_OUTPUT
            exit 1
          }
          cd "$GITHUB_WORKSPACE"
      
      - name: Check openapi-models.yaml
        id: check-models
        continue-on-error: true
        run: |
          echo "Checking openapi/openapi-models.yaml for breaking changes..."
          
          # Get the base version of the file
          git show origin/${{ steps.base-branch.outputs.base_ref }}:openapi/openapi-models.yaml > /tmp/base-openapi-models.yaml || {
            echo "File doesn't exist in base branch, skipping..."
            exit 0
          }
          
          # Copy base schema files to temp directory maintaining directory structure (reuse from api check)
          if [ ! -d /tmp/openapi-base/schemas ]; then
            mkdir -p /tmp/openapi-base/schemas
            for schema in openapi/schemas/*.json openapi/schemas/*.yaml; do
              if [ -f "$schema" ]; then
                filename=$(basename "$schema")
                git show origin/${{ steps.base-branch.outputs.base_ref }}:$schema > /tmp/openapi-base/schemas/$filename 2>/dev/null || true
              fi
            done
          fi
          
          # Move the base models file to the same directory structure
          mv /tmp/base-openapi-models.yaml /tmp/openapi-base/openapi-models.yaml
          
          # Run oasdiff - models file might not have paths, skip if invalid
          cd /tmp/openapi-base
          if oasdiff breaking openapi-models.yaml "$GITHUB_WORKSPACE/openapi/openapi-models.yaml" --composed --format text --fail-on ERR 2>/dev/null; then
            echo "✅ No breaking changes in openapi-models.yaml"
            echo "models_breaking=false" >> $GITHUB_OUTPUT
          else
            exit_code=$?
            if [ $exit_code -eq 1 ]; then
              echo "❌ Breaking changes detected in openapi-models.yaml"
              echo "models_breaking=true" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "⏭️ Skipping openapi-models.yaml (no paths defined)"
              echo "models_breaking=false" >> $GITHUB_OUTPUT
            fi
          fi
          cd "$GITHUB_WORKSPACE"
      
      - name: Check schema files
        id: check-schemas
        continue-on-error: true
        run: |
          echo "⏭️ Skipping schema files - they are validated via openapi-api.yaml references"
          echo "schemas_breaking=false" >> $GITHUB_OUTPUT
      
      - name: Summary
        if: always()
        run: |
          echo "## OpenAPI Backward Compatibility Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          api_status="${{ steps.check-api.outcome }}"
          models_status="${{ steps.check-models.outcome }}"
          schemas_status="${{ steps.check-schemas.outcome }}"
          
          echo "| File/Directory | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "$api_status" = "success" ]; then
            echo "| openapi-api.yaml | ✅ No breaking changes |" >> $GITHUB_STEP_SUMMARY
          elif [ "$api_status" = "failure" ]; then
            echo "| openapi-api.yaml | ❌ Breaking changes detected |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| openapi-api.yaml | ⏭️ Skipped or not found |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$models_status" = "success" ]; then
            echo "| openapi-models.yaml | ✅ No breaking changes |" >> $GITHUB_STEP_SUMMARY
          elif [ "$models_status" = "failure" ]; then
            echo "| openapi-models.yaml | ❌ Breaking changes detected |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| openapi-models.yaml | ⏭️ Skipped or not found |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$schemas_status" = "success" ]; then
            echo "| openapi/schemas/* | ✅ No breaking changes |" >> $GITHUB_STEP_SUMMARY
          elif [ "$schemas_status" = "failure" ]; then
            echo "| openapi/schemas/* | ❌ Breaking changes detected |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| openapi/schemas/* | ⏭️ Skipped or not found |" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Fail if breaking changes detected
        if: steps.check-api.outcome == 'failure' || steps.check-models.outcome == 'failure' || steps.check-schemas.outcome == 'failure'
        run: |
          echo "❌ Breaking changes detected in OpenAPI specifications"
          echo "Please review the changes and ensure backward compatibility or update the version accordingly."
          exit 1
