name: OpenAPI Diff

on:
  pull_request:
    paths:
      - 'openapi/**'

jobs:
  diff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check OpenAPI breaking changes
        run: |
          set -euo pipefail
          mkdir -p .openapi-diff/base .openapi-diff/head

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.sha }}"

          SPECS=(openapi/openapi-api.yaml openapi/openapi-models.yaml)

          # Materialize base revision of the entire openapi/ tree
          while IFS= read -r FILE; do
            DEST=".openapi-diff/base/${FILE#openapi/}"
            mkdir -p "$(dirname "$DEST")"
            git show "${BASE_SHA}:${FILE}" > "$DEST"
          done < <(git ls-tree -r --name-only "${BASE_SHA}" openapi)

          # Copy current revision of the openapi/ tree
          cp -R openapi/. .openapi-diff/head/
          touch .openapi-diff/README.md

          for SPEC in "${SPECS[@]}"; do
            echo "Comparing ${SPEC}"
            docker run --rm -v "${PWD}:${PWD}" -w "${PWD}" openapitools/openapi-diff:latest \
              ".openapi-diff/base/${SPEC#openapi/}" ".openapi-diff/head/${SPEC#openapi/}" \
              --fail-on-incompatible \
              --markdown ".openapi-diff/$(basename "$SPEC").diff.md"
          done

      - name: Upload diff reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openapi-diff
          path: .openapi-diff
