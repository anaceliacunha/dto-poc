name: OpenAPI Backward Compatibility

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  bc-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch (with full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          git fetch origin "${{ github.base_ref }}"

      - name: Detect changes under openapi/
        id: changed
        shell: bash
        run: |
          set -euo pipefail
          { git diff --name-only "origin/${{ github.base_ref }}...HEAD" \
              | grep -E "^openapi/" \
              || true; } > changed_openapi.txt

          # Ensure file exists even if empty
          touch changed_openapi.txt

          echo "Changed files under openapi/:"
          cat changed_openapi.txt || true

          COUNT=$(wc -l < changed_openapi.txt | tr -d ' ')
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

      - name: Skip if no specs changed
        if: steps.changed.outputs.count == '0'
        run: echo "No OpenAPI files changed. Skipping."

      - name: Prepare base versions of changed specs
        if: steps.changed.outputs.count != '0'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .openapi-old .openapi-old-bundled .openapi-new-bundled

          # Mirror the entire base openapi/ tree so $ref resolution works during bundling
          git ls-tree -r --name-only "origin/${{ github.base_ref }}" openapi | while read -r FILE; do
            mkdir -p ".openapi-old/$(dirname "$FILE")"
            git show "origin/${{ github.base_ref }}:$FILE" > ".openapi-old/$FILE"
          done

          # Record which changed specs are new (absent in base)
          while IFS= read -r f; do
            if ! [ -f ".openapi-old/$f" ]; then
              echo "NEW_FILE $f" >> .openapi-old/new_files.txt
            fi
          done < changed_openapi.txt

      - name: Run openapi-diff on changed specs (dereferenced)
        if: steps.changed.outputs.count != '0'
        shell: bash
        run: |
          set -euo pipefail
          FAILURES=0

          # Always diff the main OpenAPI specs so schema changes get picked up
          for f in openapi/openapi-api.yaml openapi/openapi-models.yaml; do
            if ! [ -f "$f" ]; then
              echo "Skipping missing spec: $f"
              continue
            fi
            echo "────────────────────────────────────────"
            echo "Comparing: origin/${{ github.base_ref }} ↔ HEAD"
            echo "$f"
            echo "────────────────────────────────────────"

            mkdir -p ".openapi-old-bundled/$(dirname "$f")" ".openapi-new-bundled/$(dirname "$f")"

            npx @redocly/cli@latest bundle ".openapi-old/$f" --dereferenced --output ".openapi-old-bundled/$f"
            npx @redocly/cli@latest bundle "$f" --dereferenced --output ".openapi-new-bundled/$f"

            docker run --rm -v "$PWD:/work" -w /work openapitools/openapi-diff:latest \
              "/work/.openapi-old-bundled/$f" "/work/.openapi-new-bundled/$f" \
              --fail-on-incompatible \
              --fail-on-changed || FAILURES=$((FAILURES+1))

            echo ""
          done

          if [ "$FAILURES" -gt 0 ]; then
            echo "::error::Detected $FAILURES breaking or changed OpenAPI schema(s)."
            exit 2
          fi

      - name: Upload diff logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openapi-diff-logs
          path: |
            changed_openapi.txt
            .openapi-old/new_files.txt
            .openapi-old-bundled
            .openapi-new-bundled
          if-no-files-found: ignore
