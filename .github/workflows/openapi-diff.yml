name: OpenAPI Diff

on:
  pull_request:
    paths:
      - 'openapi/**'

jobs:
  diff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check OpenAPI breaking changes
        run: |
          set -euo pipefail
          mkdir -p .openapi-diff/base/openapi .openapi-diff/head/openapi .openapi-diff/bundled

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.sha }}"

          SPECS=(openapi/openapi-api.yaml openapi/openapi-models.yaml)

          # Materialize base revision of the entire openapi/ tree (keep the openapi/ prefix)
          while IFS= read -r FILE; do
            DEST=".openapi-diff/base/${FILE}"
            mkdir -p "$(dirname "$DEST")"
            git show "${BASE_SHA}:${FILE}" > "$DEST"
          done < <(git ls-tree -r --name-only "${BASE_SHA}" openapi)

          # Copy current revision of the openapi/ tree
          cp -R openapi/. .openapi-diff/head/openapi/
          touch .openapi-diff/README.md

          for SPEC in "${SPECS[@]}"; do
            BASENAME="$(basename "$SPEC" .yaml)"
            BASE_SPEC=".openapi-diff/base/${SPEC}"
            HEAD_SPEC=".openapi-diff/head/${SPEC}"
            BUNDLED_BASE=".openapi-diff/bundled/${BASENAME}-base.yaml"
            BUNDLED_HEAD=".openapi-diff/bundled/${BASENAME}-head.yaml"

            npx @redocly/cli@latest bundle "$BASE_SPEC" --dereferenced --output "$BUNDLED_BASE"
            npx @redocly/cli@latest bundle "$HEAD_SPEC" --dereferenced --output "$BUNDLED_HEAD"

            echo "Comparing ${SPEC}"
            docker run --rm -v "${PWD}:${PWD}" -w "${PWD}" openapitools/openapi-diff:latest \
              "$BUNDLED_BASE" "$BUNDLED_HEAD" \
              --fail-on-incompatible \
              --fail-on-changed \
              --markdown ".openapi-diff/$(basename "$SPEC").diff.md"
          done

      - name: Upload diff reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openapi-diff
          path: .openapi-diff
