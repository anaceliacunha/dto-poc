name: OpenAPI Diff Check

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'openapi/**'

jobs:
  openapi-diff:
    runs-on: ubuntu-latest
    name: Check OpenAPI with openapi-diff
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install openapi-diff
        run: npm install -g openapi-diff
      
      - name: Get base branch
        id: base-branch
        run: |
          echo "base_ref=${{ github.base_ref }}" >> $GITHUB_OUTPUT
      
      - name: Check openapi-api.yaml
        id: check-api
        continue-on-error: true
        run: |
          echo "Checking openapi/openapi-api.yaml for breaking changes..."
          git fetch origin ${{ steps.base-branch.outputs.base_ref }}
          
          # Get the base version of the file
          git show origin/${{ steps.base-branch.outputs.base_ref }}:openapi/openapi-api.yaml > /tmp/base-openapi-api.yaml || {
            echo "File doesn't exist in base branch, skipping..."
            exit 0
          }
          
          # Check if files are different
          if diff -q /tmp/base-openapi-api.yaml openapi/openapi-api.yaml > /dev/null 2>&1; then
            echo "âœ… No changes in openapi-api.yaml"
            echo "api_breaking=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ðŸ“ File has changed, checking for breaking changes..."
          echo "========================================="
          
          # Run openapi-diff
          openapi-diff /tmp/base-openapi-api.yaml openapi/openapi-api.yaml
          
          # openapi-diff doesn't have explicit breaking change detection, just shows diffs
          echo "âœ… Diff complete for openapi-api.yaml"
          echo "api_breaking=false" >> $GITHUB_OUTPUT
      
      - name: Check openapi-models.yaml
        id: check-models
        continue-on-error: true
        run: |
          echo "Checking openapi/openapi-models.yaml for breaking changes..."
          
          # Get the base version of the file
          git show origin/${{ steps.base-branch.outputs.base_ref }}:openapi/openapi-models.yaml > /tmp/base-openapi-models.yaml || {
            echo "File doesn't exist in base branch, skipping..."
            exit 0
          }
          
          # Check if files are different
          if diff -q /tmp/base-openapi-models.yaml openapi/openapi-models.yaml > /dev/null 2>&1; then
            echo "âœ… No changes in openapi-models.yaml"
            echo "models_breaking=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ðŸ“ File has changed, checking for breaking changes..."
          echo "========================================="
          
          # Run openapi-diff
          openapi-diff /tmp/base-openapi-models.yaml openapi/openapi-models.yaml
          
          # openapi-diff doesn't have explicit breaking change detection, just shows diffs
          echo "âœ… Diff complete for openapi-models.yaml"
          echo "models_breaking=false" >> $GITHUB_OUTPUT
      
      - name: Check schema files
        id: check-schemas
        continue-on-error: true
        run: |
          echo "Checking schema files for breaking changes..."
          
          # Track if any schema has breaking changes
          schemas_have_breaking=false
          
          # Create temp directory for base schemas
          mkdir -p /tmp/base-schemas
          
          # Check each schema file (both JSON and YAML)
          for schema in openapi/schemas/*.json openapi/schemas/*.yaml; do
            if [ -f "$schema" ]; then
              filename=$(basename "$schema")
              echo ""
              echo "========================================="
              echo "Checking $schema..."
              echo "========================================="
              
              # Get base version
              if ! git show origin/${{ steps.base-branch.outputs.base_ref }}:$schema > /tmp/base-schemas/$filename 2>/dev/null; then
                echo "â­ï¸ $filename is new, skipping..."
                continue
              fi
              
              # Check if files are different
              if diff -q /tmp/base-schemas/$filename "$schema" > /dev/null 2>&1; then
                echo "âœ… No changes in $filename"
                continue
              fi
              
              echo "ðŸ“ File has changed, checking for breaking changes..."
              
              # Run openapi-diff
              openapi-diff /tmp/base-schemas/$filename $schema 2>&1 || true
              
              echo "âœ… Diff complete for $filename"
            fi
          done
          
          echo "schemas_breaking=false" >> $GITHUB_OUTPUT
      
      - name: Summary
        if: always()
        run: |
          echo "## OpenAPI Diff Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ This workflow shows diffs but does not enforce breaking change rules." >> $GITHUB_STEP_SUMMARY
          echo "See openapi-oasdiff workflow for breaking change detection." >> $GITHUB_STEP_SUMMARY
