name: Spectral OpenAPI Compatibility Check

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'openapi/**'

jobs:
  spectral-diff:
    runs-on: ubuntu-latest
    name: Check OpenAPI with Spectral
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Spectral
        run: npm install -g @stoplight/spectral-cli
      
      - name: Create Spectral ruleset
        run: |
          cat > .spectral.yml << 'EOF'
          extends: spectral:oas
          EOF
      
      - name: Lint current OpenAPI files
        continue-on-error: true
        run: |
          echo "========================================="
          echo "Linting current openapi-api.yaml"
          echo "========================================="
          spectral lint openapi/openapi-api.yaml --format stylish || true
          
          echo ""
          echo "========================================="
          echo "Linting current openapi-models.yaml"
          echo "========================================="
          spectral lint openapi/openapi-models.yaml --format stylish || true
      
      - name: Get base branch files
        continue-on-error: true
        run: |
          git fetch origin ${{ github.base_ref }}
          mkdir -p /tmp/openapi-base/schemas
          
          # Copy base branch files to temp directory
          git show origin/${{ github.base_ref }}:openapi/openapi-api.yaml > /tmp/openapi-base/openapi-api.yaml 2>/dev/null || echo "No openapi-api.yaml in base"
          git show origin/${{ github.base_ref }}:openapi/openapi-models.yaml > /tmp/openapi-base/openapi-models.yaml 2>/dev/null || echo "No openapi-models.yaml in base"
          
          # Copy schema files for reference resolution
          for schema in openapi/schemas/*.json openapi/schemas/*.yaml; do
            if [ -f "$schema" ]; then
              filename=$(basename "$schema")
              git show origin/${{ github.base_ref }}:openapi/schemas/$filename > /tmp/openapi-base/schemas/$filename 2>/dev/null || echo "No $filename in base"
            fi
          done
      
      - name: Lint base branch files
        continue-on-error: true
        run: |
          cd /tmp/openapi-base
          
          if [ -f openapi-api.yaml ]; then
            echo ""
            echo "========================================="
            echo "Base version of openapi-api.yaml:"
            echo "========================================="
            spectral lint openapi-api.yaml --format stylish || true
          fi
          
          if [ -f openapi-models.yaml ]; then
            echo ""
            echo "========================================="
            echo "Base version of openapi-models.yaml:"
            echo "========================================="
            spectral lint openapi-models.yaml --format stylish || true
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "## Spectral OpenAPI Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ℹ️ Spectral performs OpenAPI linting and validation." >> $GITHUB_STEP_SUMMARY
          echo "Review the output above for any errors or warnings." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For breaking change detection, refer to the openapi-oasdiff workflow." >> $GITHUB_STEP_SUMMARY
